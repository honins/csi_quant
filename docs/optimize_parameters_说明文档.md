# optimize_parameters å‚æ•°ä¼˜åŒ–åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## æ¦‚è¿°

`optimize_parameters` æ˜¯ CSI Quant é¡¹ç›®ä¸­çš„æ ¸å¿ƒå‚æ•°ä¼˜åŒ–åŠŸèƒ½ï¼Œä½äº `src/ai/parameter_optimizer.py` æ–‡ä»¶ä¸­çš„ `ParameterOptimizer` ç±»ã€‚è¯¥åŠŸèƒ½æä¾›äº†å¤šç§ä¼˜åŒ–ç®—æ³•æ¥è‡ªåŠ¨å¯»æ‰¾ç­–ç•¥çš„æœ€ä½³å‚æ•°ç»„åˆï¼Œä»¥æå‡äº¤æ˜“ç­–ç•¥çš„è¡¨ç°ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ æ”¯æŒçš„ä¼˜åŒ–ç®—æ³•

1. **ç½‘æ ¼æœç´¢ (Grid Search)**
   - ç³»ç»Ÿæ€§åœ°éå†æ‰€æœ‰å‚æ•°ç»„åˆ
   - é€‚ç”¨äºå‚æ•°ç©ºé—´è¾ƒå°çš„æƒ…å†µ
   - ä¿è¯æ‰¾åˆ°å…¨å±€æœ€ä¼˜è§£ï¼ˆåœ¨æœç´¢èŒƒå›´å†…ï¼‰

2. **éšæœºæœç´¢ (Random Search)**
   - éšæœºé‡‡æ ·å‚æ•°ç»„åˆè¿›è¡Œè¯„ä¼°
   - é€‚ç”¨äºé«˜ç»´å‚æ•°ç©ºé—´
   - è®¡ç®—æ•ˆç‡é«˜ï¼Œé€‚åˆå¿«é€Ÿæ¢ç´¢

3. **è´å¶æ–¯ä¼˜åŒ– (Bayesian Optimization)**
   - åŸºäºé«˜æ–¯è¿‡ç¨‹çš„æ™ºèƒ½ä¼˜åŒ–ç®—æ³•
   - åˆ©ç”¨å†å²è¯„ä¼°ç»“æœæŒ‡å¯¼ä¸‹ä¸€æ­¥æœç´¢
   - åœ¨æœ‰é™è¿­ä»£æ¬¡æ•°å†…æ‰¾åˆ°è¾ƒä¼˜è§£
   - éœ€è¦å®‰è£… `scikit-optimize` åº“

4. **è‡ªé€‚åº”éšæœºæœç´¢ (Adaptive Random Search)**
   - è´å¶æ–¯ä¼˜åŒ–çš„å¤‡é€‰æ–¹æ¡ˆ
   - æ ¹æ®å†å²è¡¨ç°è°ƒæ•´å‚æ•°ç”Ÿæˆç­–ç•¥
   - æ— éœ€é¢å¤–ä¾èµ–åº“

## æ–¹æ³•ç­¾å

```python
def optimize_parameters(self, 
                       strategy_module,
                       data,
                       param_ranges: Dict[str, Any],
                       method: str = 'random',
                       max_iterations: int = 100) -> Dict[str, Any]:
```

## å‚æ•°è¯´æ˜

### è¾“å…¥å‚æ•°

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `strategy_module` | ç­–ç•¥æ¨¡å—å®ä¾‹ | - | éœ€è¦ä¼˜åŒ–çš„ç­–ç•¥æ¨¡å—å¯¹è±¡ |
| `data` | DataFrame | - | ç”¨äºå›æµ‹çš„å†å²æ•°æ® |
| `param_ranges` | Dict[str, Any] | - | å‚æ•°æœç´¢èŒƒå›´é…ç½® |
| `method` | str | 'random' | ä¼˜åŒ–æ–¹æ³•ï¼š'grid', 'random', 'bayesian' |
| `max_iterations` | int | 100 | æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆç½‘æ ¼æœç´¢é™¤å¤–ï¼‰ |

### å‚æ•°èŒƒå›´é…ç½®æ ¼å¼

```python
param_ranges = {
    'parameter_name': {
        'min': 0.1,      # æœ€å°å€¼
        'max': 0.9,      # æœ€å¤§å€¼
        'type': 'float'  # å‚æ•°ç±»å‹ï¼š'float' æˆ– 'int'
    },
    # æ›´å¤šå‚æ•°...
}
```

### è¿”å›å€¼

è¿”å›ä¸€ä¸ªåŒ…å«ä¼˜åŒ–ç»“æœçš„å­—å…¸ï¼š

```python
{
    'success': bool,                    # ä¼˜åŒ–æ˜¯å¦æˆåŠŸ
    'method': str,                      # ä½¿ç”¨çš„ä¼˜åŒ–æ–¹æ³•
    'best_params': Dict[str, Any],      # æœ€ä½³å‚æ•°ç»„åˆ
    'best_score': float,                # æœ€ä½³å¾—åˆ†
    'best_metrics': Dict[str, Any],     # æœ€ä½³å‚æ•°çš„è¯¦ç»†æŒ‡æ ‡
    'iterations': int,                  # å®é™…è¿­ä»£æ¬¡æ•°
    'improvements': int,                # æ”¹è¿›æ¬¡æ•°
    'optimization_time': float,         # ä¼˜åŒ–è€—æ—¶ï¼ˆç§’ï¼‰
    'timestamp': str,                   # ä¼˜åŒ–å®Œæˆæ—¶é—´æˆ³
    'error': str                        # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
}
```

## è¯„åˆ†æœºåˆ¶

### è¯„åˆ†æŒ‡æ ‡

ä¼˜åŒ–å™¨ä½¿ç”¨å¤šç»´åº¦è¯„åˆ†æœºåˆ¶æ¥è¯„ä¼°å‚æ•°ç»„åˆçš„è¡¨ç°ï¼š

1. **æˆåŠŸç‡å¾—åˆ†** (`success_rate`)
   - æƒé‡ï¼šé»˜è®¤ 40%
   - è®¡ç®—ï¼šé¢„æµ‹æˆåŠŸçš„æ¯”ä¾‹

2. **å¹³å‡æ¶¨å¹…å¾—åˆ†** (`avg_rise`)
   - æƒé‡ï¼šé»˜è®¤ 30%
   - è®¡ç®—ï¼šç›¸å¯¹äºåŸºå‡†æ¶¨å¹…ï¼ˆ4%ï¼‰çš„è¡¨ç°

3. **å¹³å‡å¤©æ•°å¾—åˆ†** (`avg_days`)
   - æƒé‡ï¼šé»˜è®¤ 20%
   - è®¡ç®—ï¼šæŒä»“å¤©æ•°è¶Šå°‘å¾—åˆ†è¶Šé«˜

4. **é£é™©æƒ©ç½š** (`risk_penalty`)
   - æƒé‡ï¼šé»˜è®¤ 10%
   - è®¡ç®—ï¼šä¿¡å·æ•°é‡è¿‡å°‘æ—¶çš„æƒ©ç½š

### å¾—åˆ†è®¡ç®—å…¬å¼

```python
total_score = (success_rate * 0.4) + 
              (min(avg_rise/0.04, 2.0) * 0.3) + 
              (max(0, (20-avg_days)/20) * 0.2) - 
              (risk_penalty * 0.1)
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```python
from src.ai.parameter_optimizer import ParameterOptimizer

# åˆå§‹åŒ–ä¼˜åŒ–å™¨
optimizer = ParameterOptimizer()

# å®šä¹‰å‚æ•°æœç´¢èŒƒå›´
param_ranges = {
    'confidence_threshold': {'min': 0.1, 'max': 0.9, 'type': 'float'},
    'volume_threshold': {'min': 1.0, 'max': 5.0, 'type': 'float'},
    'lookback_days': {'min': 5, 'max': 30, 'type': 'int'}
}

# æ‰§è¡Œéšæœºæœç´¢ä¼˜åŒ–
result = optimizer.optimize_parameters(
    strategy_module=my_strategy,
    data=historical_data,
    param_ranges=param_ranges,
    method='random',
    max_iterations=200
)

# æ£€æŸ¥ç»“æœ
if result['success']:
    print(f"æœ€ä½³å‚æ•°: {result['best_params']}")
    print(f"æœ€ä½³å¾—åˆ†: {result['best_score']:.4f}")
    print(f"ä¼˜åŒ–è€—æ—¶: {result['optimization_time']:.2f}ç§’")
else:
    print(f"ä¼˜åŒ–å¤±è´¥: {result['error']}")
```

### è´å¶æ–¯ä¼˜åŒ–ç¤ºä¾‹

```python
# ä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–ï¼ˆéœ€è¦å®‰è£… scikit-optimizeï¼‰
result = optimizer.optimize_parameters(
    strategy_module=my_strategy,
    data=historical_data,
    param_ranges=param_ranges,
    method='bayesian',
    max_iterations=100
)
```

### ç½‘æ ¼æœç´¢ç¤ºä¾‹

```python
# ç½‘æ ¼æœç´¢ï¼ˆé€‚ç”¨äºå‚æ•°ç©ºé—´è¾ƒå°çš„æƒ…å†µï¼‰
result = optimizer.optimize_parameters(
    strategy_module=my_strategy,
    data=historical_data,
    param_ranges=param_ranges,
    method='grid'
    # max_iterations å‚æ•°å¯¹ç½‘æ ¼æœç´¢æ— æ•ˆ
)
```

## é…ç½®é€‰é¡¹

### è´å¶æ–¯ä¼˜åŒ–é…ç½®

å¯ä»¥é€šè¿‡ä¿®æ”¹ `bayesian_config` æ¥è°ƒæ•´è´å¶æ–¯ä¼˜åŒ–çš„è¡Œä¸ºï¼š

```python
optimizer.bayesian_config = {
    'n_calls': 120,              # æ€»è°ƒç”¨æ¬¡æ•°
    'n_initial_points': 25,      # åˆå§‹éšæœºç‚¹æ•°é‡
    'acq_func': 'EI',           # é‡‡é›†å‡½æ•°ï¼š'EI', 'PI', 'LCB'
    'xi': 0.01,                 # æ¢ç´¢å‚æ•°
    'kappa': 1.96,              # ç½®ä¿¡å‚æ•°
    'random_state': 42          # éšæœºç§å­
}
```

### è¯„åˆ†æƒé‡é…ç½®

å¯ä»¥è°ƒæ•´è¯„åˆ†æƒé‡æ¥é€‚åº”ä¸åŒçš„ä¼˜åŒ–ç›®æ ‡ï¼š

```python
optimizer.scoring_weights = {
    'success_rate': 0.5,    # æ›´é‡è§†æˆåŠŸç‡
    'avg_rise': 0.3,        # æ¶¨å¹…æƒé‡
    'avg_days': 0.1,        # å¤©æ•°æƒé‡
    'risk_penalty': 0.1     # é£é™©æƒ©ç½šæƒé‡
}
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–æ–¹æ³•

- **å‚æ•°æ•°é‡ < 5ï¼Œæœç´¢ç©ºé—´å°**ï¼šä½¿ç”¨ç½‘æ ¼æœç´¢
- **å‚æ•°æ•°é‡ 5-15ï¼Œä¸­ç­‰æœç´¢ç©ºé—´**ï¼šä½¿ç”¨éšæœºæœç´¢
- **å‚æ•°æ•°é‡ > 15ï¼Œå¤§æœç´¢ç©ºé—´**ï¼šä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–

### 2. åˆç†è®¾ç½®è¿­ä»£æ¬¡æ•°

- **éšæœºæœç´¢**ï¼š100-500 æ¬¡è¿­ä»£
- **è´å¶æ–¯ä¼˜åŒ–**ï¼š50-200 æ¬¡è¿­ä»£
- **ç½‘æ ¼æœç´¢**ï¼šè‡ªåŠ¨è®¡ç®—ï¼Œæ³¨æ„ç»„åˆæ•°é‡

### 3. æ•°æ®é‡è¦æ±‚

- æœ€å°‘éœ€è¦ 100 æ¡å†å²æ•°æ®
- æ¨èä½¿ç”¨ 500+ æ¡æ•°æ®ä»¥è·å¾—ç¨³å®šç»“æœ
- æ•°æ®è´¨é‡æ¯”æ•°é‡æ›´é‡è¦

### 4. å‚æ•°èŒƒå›´è®¾ç½®

- åŸºäºä¸šåŠ¡ç»éªŒè®¾ç½®åˆç†çš„å‚æ•°èŒƒå›´
- é¿å…è¿‡å¤§çš„æœç´¢ç©ºé—´å¯¼è‡´æ•ˆç‡ä½ä¸‹
- å¯ä»¥å…ˆç”¨ç²—ç²’åº¦æœç´¢ï¼Œå†ç»†åŒ–èŒƒå›´

## è¾“å‡ºå’Œæ—¥å¿—

### ä¼˜åŒ–è¿‡ç¨‹æ—¥å¿—

ä¼˜åŒ–å™¨ä¼šè¾“å‡ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼š

```
[INFO] å¼€å§‹å‚æ•°ä¼˜åŒ–ï¼Œæ–¹æ³•: randomï¼Œæœ€å¤§è¿­ä»£: 200
[INFO] éšæœºæœç´¢è¿›åº¦: 10.0% (20/200), å·²ç”¨æ—¶: 15.3ç§’
[INFO] å‘ç°æ›´å¥½å‚æ•° (ç¬¬3æ¬¡æ”¹è¿›, è¿­ä»£45): å¾—åˆ†=7.2341
[INFO] éšæœºæœç´¢è¿›åº¦: 50.0% (100/200), å·²ç”¨æ—¶: 78.1ç§’
[INFO] ä¼˜åŒ–å®Œæˆï¼Œæœ€ä½³å¾—åˆ†: 7.8923ï¼Œæ€»è€—æ—¶: 156.7ç§’
```

### ç»“æœä¿å­˜

ä¼˜åŒ–ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š
- **æ–‡ä»¶ä½ç½®**ï¼š`results/optimization_{method}_{timestamp}.json`
- **å†å²è®°å½•**ï¼šå†…å­˜ä¸­ä¿ç•™æœ€è¿‘çš„ä¼˜åŒ–å†å²
- **æœ€ä½³å‚æ•°**ï¼šè‡ªåŠ¨æ›´æ–°å…¨å±€æœ€ä½³å‚æ•°è®°å½•

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

1. **æ•°æ®éªŒè¯å¤±è´¥**
   ```
   é”™è¯¯ï¼šè¾“å…¥éªŒè¯å¤±è´¥: ['æ•°æ®é‡ä¸è¶³ï¼Œéœ€è¦è‡³å°‘100æ¡ï¼Œå®é™…50æ¡']
   è§£å†³ï¼šå¢åŠ å†å²æ•°æ®é‡æˆ–é™ä½æœ€å°æ•°æ®è¦æ±‚
   ```

2. **å‚æ•°é…ç½®é”™è¯¯**
   ```
   é”™è¯¯ï¼šå‚æ•° confidence_threshold ç¼ºå°‘ max é…ç½®
   è§£å†³ï¼šæ£€æŸ¥ param_ranges é…ç½®æ ¼å¼
   ```

3. **è´å¶æ–¯ä¼˜åŒ–ä¾èµ–ç¼ºå¤±**
   ```
   è­¦å‘Šï¼šscikit-optimizeæœªå®‰è£…ï¼Œå›é€€åˆ°è‡ªé€‚åº”éšæœºæœç´¢
   è§£å†³ï¼špip install scikit-optimize
   ```

4. **ç­–ç•¥æ¨¡å—æ¥å£ä¸å…¼å®¹**
   ```
   é”™è¯¯ï¼šstrategy_module ç¼ºå°‘å¿…è¦çš„æ–¹æ³•
   è§£å†³ï¼šç¡®ä¿ç­–ç•¥æ¨¡å—å®ç°äº† update_params, backtest, evaluate_strategy æ–¹æ³•
   ```

## æ‰©å±•å’Œè‡ªå®šä¹‰

### æ·»åŠ æ–°çš„ä¼˜åŒ–ç®—æ³•

1. åœ¨ `optimize_parameters` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„åˆ†æ”¯
2. å®ç°å¯¹åº”çš„ç§æœ‰æ–¹æ³•ï¼ˆå¦‚ `_custom_optimization`ï¼‰
3. éµå¾ªç»Ÿä¸€çš„è¿”å›æ ¼å¼

### è‡ªå®šä¹‰è¯„åˆ†å‡½æ•°

é‡å†™ `_calculate_score` æ–¹æ³•æ¥å®ç°è‡ªå®šä¹‰çš„è¯„åˆ†é€»è¾‘ï¼š

```python
def _calculate_score(self, metrics: Dict[str, Any]) -> float:
    # è‡ªå®šä¹‰è¯„åˆ†é€»è¾‘
    custom_score = your_scoring_function(metrics)
    return custom_score
```

### æ·»åŠ æ–°çš„è¯„ä¼°æŒ‡æ ‡

åœ¨ç­–ç•¥æ¨¡å—çš„ `evaluate_strategy` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æŒ‡æ ‡ï¼Œä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨è¿™äº›æŒ‡æ ‡è¿›è¡Œè¯„åˆ†ã€‚

## æœ€ä½³å®è·µ

1. **æ¸è¿›å¼ä¼˜åŒ–**ï¼šå…ˆç”¨ç²—ç²’åº¦å‚æ•°èŒƒå›´å¿«é€Ÿæ¢ç´¢ï¼Œå†ç»†åŒ–ä¼˜åŒ–
2. **äº¤å‰éªŒè¯**ï¼šä½¿ç”¨ä¸åŒæ—¶é—´æ®µçš„æ•°æ®éªŒè¯ä¼˜åŒ–ç»“æœçš„ç¨³å®šæ€§
3. **å‚æ•°åˆç†æ€§æ£€æŸ¥**ï¼šä¼˜åŒ–åçš„å‚æ•°åº”è¯¥ç¬¦åˆä¸šåŠ¡é€»è¾‘
4. **æ€§èƒ½ç›‘æ§**ï¼šå…³æ³¨ä¼˜åŒ–è¿‡ç¨‹çš„å†…å­˜å’ŒCPUä½¿ç”¨æƒ…å†µ
5. **ç»“æœåˆ†æ**ï¼šä¸ä»…å…³æ³¨æœ€ä½³å¾—åˆ†ï¼Œè¿˜è¦åˆ†æå‚æ•°åˆ†å¸ƒå’Œæ”¹è¿›è¶‹åŠ¿

## ç›¸å…³æ–‡ä»¶

- **ä¸»è¦å®ç°**ï¼š`src/ai/parameter_optimizer.py`
- **å‚æ•°é…ç½®**ï¼š`src/utils/param_config.py`
- **ä¼˜åŒ–ç»“æœä¿å­˜**ï¼š`src/utils/optimized_params_saver.py`
- **é…ç½®æ–‡ä»¶**ï¼š`config/optimized_params.yaml`
- **ä½¿ç”¨ç¤ºä¾‹**ï¼š`examples/` ç›®å½•ä¸‹çš„ç›¸å…³æ–‡ä»¶

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´ï¼š2025å¹´1æœˆ*