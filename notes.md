# 项目笔记

## 重要信息记录

### 2025-01-28 失败分析模块优化完成

#### 问题解决
1. **失败案例检测逻辑改进**：
   - 修复了analyze_failures.py中的失败案例识别逻辑
   - 正确处理CSV数据中的字符串类型布尔值（'True'/'False'）
   - 添加了价格字段映射，使用"预测价格"作为信号价格

2. **数据匹配逻辑优化**：
   - 改进了failure_analysis.py中的_analyze_single_failure方法
   - 增强了价格信息获取逻辑，支持多种字段名（price、close、close_price）
   - 添加了从历史数据中查找价格的备用机制
   - 完善了错误处理和详细的错误信息

#### 分析结果
- 成功识别了20个失败案例，失败率27.03%
- 主要失败类型：near_miss_timing（95%），即在观察期外达到目标涨幅
- 系统建议：降低成功阈值至3.6%，延长观察期至25天

#### 技术要点
- CSV数据格式：日期,预测价格,预测低点,置信度,策略置信度,使用阈值,实际低点,趋势状态,未来最大涨幅,涨幅天数,预测正确,策略原因,策略指标
- 失败分析现在能正确分类失败类型并提供具体的改进建议
- 数据匹配问题已完全解决，不再出现"无法找到价格信息"错误

### confidence vs strategy_confidence 区别说明

#### confidence（AI置信度）
- 来源：AI模型预测结果
- 计算：通过ai_optimizer.predict_low_point获得
- 用途：用于最终决策，与动态调整的阈值比较决定是否为低点
- 特点：综合考虑多种因素的AI模型输出

#### strategy_confidence（策略置信度）  
- 来源：策略模块计算结果
- 计算：通过strategy_module.identify_relative_low基于技术指标计算
- 用途：仅作为参考信息，用于分析和优化
- 特点：基于传统技术分析指标的确定性计算

两者的主要区别：
- confidence是AI模型的综合判断，用于实际决策
- strategy_confidence是技术指标的量化结果，用于辅助分析
- 最终的is_predicted_low_point由confidence与阈值比较决定

## 失败分析模块使用总结 (2025-09-28)

### 分析目标
使用 `failure_analysis.py` 模块对错判样本进行分析，输出改进建议。

### 实施过程
1. **创建分析脚本**: 开发了 `analyze_failures.py` 脚本，集成 `FailureAnalyzer` 类
2. **数据加载问题**: 解决了多个数据加载相关的问题：
   - `utils.data_loader` 模块不存在 → 改用 `data.data_module.DataModule`
   - `ConfigLoader` 使用错误 → 直接导入 `load_config` 函数
   - CSV字段映射问题 → 正确映射回测结果字段

### 主要发现
1. **失败案例检测问题**: 
   - 当前回测结果显示所有预测都是错误的（预测正确数: 0），但系统未能正确识别失败案例
   - 原因：失败案例的定义是"预测为低点但未来涨幅未达到阈值"，而当前数据中预测为低点的数量为0

2. **数据匹配问题**:
   - `FailureAnalyzer` 在分析时出现"无法找到价格信息"错误
   - 表明历史数据与回测结果的日期匹配存在问题

3. **模块功能验证**:
   - 通过创建模拟失败案例，成功验证了 `failure_analysis` 模块的基本功能
   - 模块能够分类失败类型并生成JSON格式的分析报告

### 改进建议
1. **优化失败案例检测逻辑**: 需要重新审视失败案例的定义和检测条件
2. **修复数据匹配问题**: 改进 `FailureAnalyzer` 中的日期和价格数据匹配逻辑
3. **增强分析深度**: 当前分析主要识别为"data_error"，需要更精细的失败类型分类

### 技术细节
- 回测数据字段: `预测低点`(True/False), `预测正确`(True/False), `未来最大涨幅`
- 涨幅阈值: 0.04 (4%)
- 分析结果保存路径: `results/failure_analysis_*.json`

# 项目记录

## 项目概述

本项目是一个基于机器学习的量化交易系统，专注于中证500指数的预测和分析。

### 核心功能

1. **CSI 500 (000905)**
   - 数据获取和处理
   - 技术指标计算
   - 机器学习模型训练
   - 预测和回测

### 数据结构

- CSI 500数据: `data/SHSE.000905_1d.csv`

## 2025年7-8月回测记录 (2025-09-27 23:45:20)

### 回测执行状态
- ✅ **回测完成**: 2025-07-01 至 2025-08-31 (62天)
- ✅ **报告生成**: `results/reports/report_rolling_backtest_20250927_234520.md`
- ✅ **明细导出**: `results/csv/daily_details_rolling_backtest_20250927_234520.csv`

### 核心回测结果
- **预测成功率**: **9.09%** (4/44) ⚠️ **表现较差**
- **F1 Score**: **16.67%**
- **Precision**: 100.00% (预测为正的全部正确)
- **Recall**: 9.09% (漏掉了大量机会)
- **平均置信度**: 0.2712

### 市场环境分析
- **市场趋势**: 全部44天均为牛市环境
- **模型表现**: 在牛市中命中率仅9.09%，严重低估
- **置信度分布**: 84.09%的预测置信度低于0.4

### 高置信度预测分析
- **高置信度预测** (>0.5): 4个，**全部正确** (100%准确率)
  - 2025-08-01: 置信度87%, 涨幅13.37% ✅
  - 2025-07-31: 置信度84%, 涨幅13.13% ✅
  - 2025-08-04: 置信度79%, 涨幅13.55% ✅
  - 2025-08-08: 置信度58%, 涨幅12.44% ✅

### 关键发现
1. **高置信度可靠**: 置信度>0.5的预测准确率100%
2. **保守策略**: 模型过于保守，错过大量机会
3. **置信度相关性**: confidence vs future_max_rise = 0.683 (较强相关)
4. **阈值问题**: 当前0.5阈值可能过高，导致漏掉机会

### 策略参数
- 涨幅阈值: 4.0%
- 最大观察天数: 20天
- 置信度阈值: 0.50

### 生成文件
- 📄 **回测报告**: `results/reports/report_rolling_backtest_20250927_234520.md`
- 🧾 **每日明细**: `results/csv/daily_details_rolling_backtest_20250927_234520.csv`

### 优化建议
1. **降低置信度阈值**: 考虑将阈值从0.5降至0.3-0.4
2. **参数调优**: 针对牛市环境优化策略参数
3. **模型重训练**: 考虑使用更多牛市数据重新训练

## 最近一个月回测记录 (2025-09-27 23:38:22)

### 回测执行状态
- ✅ **回测完成**: 2025-08-28 至 2025-09-27 (30天)
- ✅ **报告生成**: `results/reports/report_rolling_backtest_20250927_233822.md`
- ✅ **明细导出**: `results/csv/daily_details_rolling_backtest_20250927_233822.csv`

### 核心回测结果
- **预测成功率**: 76.19% (16/21)
- **F1 Score**: 70.59%
- **Precision**: 66.67%
- **Recall**: 75.00%
- **平均置信度**: 0.4486

### 趋势识别能力
- **牛市趋势**: 19个样本，命中率 78.95%
- **震荡区间**: 1个样本，命中率 100.00%
- **置信度相关性**: confidence vs future_max_rise = 0.711

### 置信度质量分析
- **高置信度预测** (>0.6): 8个，正确率 75.00%
- **中等置信度** (0.4-0.6): 2个，正确率 100.00%
- **低置信度** (<0.4): 11个，正确率 72.73%

### 策略参数
- 涨幅阈值: 4.0%
- 最大观察天数: 20天
- 置信度阈值: 0.50

### 生成文件
- 📄 **回测报告**: `results/reports/report_rolling_backtest_20250927_233822.md`
- 🧾 **每日明细**: `results/csv/daily_details_rolling_backtest_20250927_233822.csv`

### 技术细节
- 使用已训练模型，无需重新训练
- 训练效率: 节省 100.0% (0/21)
- 数据源: 中证500指数 (SHSE.000905)

### 重要发现
1. **模型稳定性**: 76.19%的成功率表现良好
2. **置信度可靠性**: 0.711的相关性显示置信度与实际涨幅高度相关
3. **趋势适应性**: 在牛市环境下表现优异 (78.95%命中率)


### 移除中证1000相关数据和代码

**修改内容:**
1. **数据获取模块修改** (`src/data/fetch_latest_data.py`)
   - 移除000852相关代码和注释
   - 修改symbols列表，只保留000905
   - 更新文档注释

2. **数据文件清理**
   - 删除 `data/SHSE.000852_1d.csv`
   - 保留 `data/SHSE.000905_1d.csv`

3. **预测脚本修改** (`predict_recent_month.py`)
   - 将数据文件路径从000852改为000905

4. **文档更新** (`notes.md`)
   - 专注于中证500

**测试结果:**
- ✅ 数据获取功能正常，只获取中证500数据
- ✅ 预测功能正常，成功生成30天预测报告
- ✅ 系统现在专注于中证500指数分析

**影响范围:**
- 系统现在只处理中证500 (000905) 数据
- 所有功能模块已适配单一指数处理
- 配置和文档已同步更新


### 执行状态
- **执行时间**: 2025-09-27 23:13:45
- **执行状态**: 成功 ✅
- **数据源**: akshare
- **更新方式**: 增量更新

### 更新的指数数据
1. **CSI 500 (000905)**
   - 新增数据: 5条记录
   - 总数据量: 2612条
   - 最新日期: 2025-09-26
   - 最新收盘价: 5825.37

### 文件位置
- CSI 500数据: `data/SHSE.000905_1d.csv`

### 技术细节
- 数据源: akshare
- 更新方式: 增量更新
- 虚拟环境: 已激活 (G:\repo\csi_quant\venv)
- 数据格式: CSV
- 执行耗时: 3.90秒
- 执行命令: `python run.py fetch`

### 重要信息
- 系统支持增量更新，避免重复下载历史数据
- 数据已准备就绪，可用于策略分析和回测

## 滚动回测记录 (2025-09-27 23:15:01)

### 执行状态
- **执行时间**: 2025-09-27 23:15:01
- **执行状态**: 成功 ✅
- **回测期间**: 2025-08-28 至 2025-09-27 (最近一个月)
- **执行耗时**: 2.08秒

### 回测结果
- **总预测日期数**: 21天
- **正确预测数**: 16天
- **预测成功率**: 76.19%
- **Precision**: 66.67%
- **Recall**: 75.00%
- **F1 Score**: 70.59%
- **Specificity**: 76.92%
- **Balanced Accuracy**: 75.96%

### 策略参数
- **涨幅阈值**: 4.0%
- **最大观察天数**: 20天
- **置信度阈值**: 0.50
- **RSI超卖阈值**: 30
- **RSI偏低阈值**: 40

### 置信度分析
- **均值**: 0.4486
- **标准差**: 0.2364
- **最小值**: 0.2032
- **最大值**: 0.8940
- **相关性**: confidence vs future_max_rise = 0.711

### 趋势分布
- **多头趋势(bull)**: 19天，命中率78.95%
- **震荡趋势(sideways)**: 1天，命中率100.00%
- **未知趋势(unknown)**: 1天，命中率0.00%

### 生成文件
- **详细报告**: `results/reports/report_rolling_backtest_20250927_231501.md`
- **每日明细CSV**: `results/csv/daily_details_rolling_backtest_20250927_231501.csv`

### 技术细节
- **使用模型**: 已训练模型（禁止回测训练）
- **训练效率**: 0/21 (节省100.0%)
- **虚拟环境**: 已激活
- **执行命令**: `python run.py backtest 2025-08-28 2025-09-27`

### 重要发现
1. 模型在多头趋势中表现良好，命中率接近79%
2. 置信度与未来涨幅呈现较强正相关(0.711)
3. 高置信度信号(>0.8)表现优异，如9月4日(0.89置信度，9.60%涨幅)
4. 系统成功识别了震荡区间，并在该区间内实现100%命中率


## 小型实验记录 (2025-09-28 00:02:04)

### 环境
- **虚拟环境**: venv (Windows 激活 `venv\Scripts\activate`)
- **依赖安装**: `python -m pip install -r requirements.txt`

### 训练
- **命令**: `python run.py ai --quick`
- **耗时**: 8.3秒
- **要点**: 保持 `final_threshold=0.5`（不改动）；模型训练使用 `class_weight='balanced'`
- **结果**: 模型保存成功，策略参数优化完成

### 滚动回测
- **命令**: `python run.py r 2025-07-01 2025-08-31`
- **报告**: `results/reports/report_rolling_backtest_20250928_000204.md`
- **指标**: 成功率 54.55%，F1 0.706，Recall 0.545，Precision 1.000
- **说明**: 阈值=0.5 严格保持；报告包含置信度分布与概率校准评估

### 结论/后续
- 本次为小型实验，仅做流程验证与报告生成
- 保持市场尊重：不修改核心逻辑与阈值
- 后续若需要A/B测试，可使用回测脚本的 override_dynamic_threshold 选项（保持默认关闭）